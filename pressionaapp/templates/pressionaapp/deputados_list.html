{% extends "pressionaapp/base.html" %}
{% load custom_tags %}

{% block title %}Deputados Federais - Blindagem Não{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-users"></i> Deputados Federais
                <small class="text-muted">({{ page_obj.paginator.count }} deputados)</small>
            </h1>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-primary">
                    <i class="fas fa-users"></i> Total
                </h5>
                <h3 class="text-primary">{{ page_obj.paginator.count }}</h3>
                <small class="text-muted">Deputados</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-info">
                    <i class="fab fa-x-twitter"></i> Com Twitter
                </h5>
                <h3 class="text-info">{{ com_redes_sociais }}</h3>
                <small class="text-muted">{{ percentual_com_redes|floatformat:1 }}%</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-warning">
                    <i class="fas fa-ban"></i> Sem Twitter
                </h5>
                <h3 class="text-warning">{{ sem_redes_sociais }}</h3>
                <small class="text-muted">{{ percentual_sem_redes|floatformat:1 }}%</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-info">
                    <i class="fas fa-flag"></i> Estados
                </h5>
                <h3 class="text-info">{{ total_estados }}</h3>
                <small class="text-muted">Representados</small>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-filter"></i> Filtros
                </h5>
            </div>
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-4">
                        <label for="search" class="form-label">Buscar:</label>
                        <input type="text" class="form-control" id="search" name="search" value="{{ search_query }}" placeholder="Nome do deputado...">
                    </div>
                    <div class="col-md-2">
                        <label for="partido" class="form-label">Partido:</label>
                        <select class="form-select" id="partido" name="partido">
                            <option value="">Todos</option>
                            {% for partido in partidos %}
                                <option value="{{ partido }}" {% if partido_filter == partido %}selected{% endif %}>{{ partido }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="uf" class="form-label">Estado:</label>
                        <select class="form-select" id="uf" name="uf">
                            <option value="">Todos</option>
                            {% for uf in ufs %}
                                <option value="{{ uf }}" {% if uf_filter == uf %}selected{% endif %}>{{ uf }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="has_social_media" class="form-label">Twitter:</label>
                        <select class="form-select" id="has_social_media" name="has_social_media">
                            <option value="">Todos</option>
                            <option value="yes" {% if has_social_media == 'yes' %}selected{% endif %}>Com Twitter</option>
                            <option value="no" {% if has_social_media == 'no' %}selected{% endif %}>Sem Twitter</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-primary d-block">
                            <i class="fas fa-search"></i> Filtrar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Deputies List -->
<div class="row">
    {% for deputado in page_obj %}
        <div class="col-lg-6 col-xl-4 mb-4">
            <div class="card deputy-card h-100 {% if deputado.has_social_media %}has-social-media{% else %}no-social-media{% endif %}">
                <div class="card-body">
                    <div class="row">
                        <div class="col-auto">
                            {% if deputado.foto_url %}
                                <img src="{{ deputado.foto_url }}" alt="{{ deputado.nome_parlamentar }}" class="deputy-photo" onerror="this.src='https://via.placeholder.com/80x80?text=Foto'">
                            {% else %}
                                <div class="deputy-photo bg-secondary d-flex align-items-center justify-content-center">
                                    <i class="fas fa-user text-white"></i>
                                </div>
                            {% endif %}
                        </div>
                        <div class="col">
                            <h6 class="card-title mb-1">{{ deputado.nome_parlamentar }}</h6>
                            <p class="card-text small text-muted mb-1">
                                {{ deputado.partido }}/{{ deputado.uf }}
                            </p>
                            {% if deputado.email %}
                                <p class="card-text small mb-1">
                                    <i class="fas fa-envelope"></i> {{ deputado.email }}
                                </p>
                            {% endif %}
                            {% if deputado.telefone %}
                                <p class="card-text small mb-1">
                                    <i class="fas fa-phone"></i> {{ deputado.telefone }}
                                </p>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Twitter Message Dropdown -->
                    {% if deputado.twitter_url and deputado.latest_tweet_url %}
                        <div class="social-links mt-3">
                            <strong class="small">Enviar mensagem:</strong><br>
                            <small class="text-muted d-block mb-2">@{{ deputado.twitter_url|get_twitter_handle }}</small>
                            
                            <select class="form-select form-select-sm mb-2" id="messageSelect{{ deputado.api_id }}" 
                                    onchange="handleMessageSelectionList(this, '{{ deputado.api_id }}', 'deputado', '{{ deputado.latest_tweet_url }}', '@{{ deputado.twitter_url|get_twitter_handle }}')">
                                <option value="">Selecione uma mensagem...</option>
                                {% get_available_messages deputado as available_messages %}
                                {% for message in available_messages %}
                                    <option value="{{ message.id }}" 
                                            data-message="{{ message.message }}" 
                                            data-hashtags="{{ message.hashtags|default:'' }}" 
                                            data-mentions="{{ message.mentions|default:'' }}">
                                        {{ message.title|truncatechars:30 }}
                                    </option>
                                {% endfor %}
                            </select>
                            
                            <button id="sendButtonList{{ deputado.api_id }}" class="btn btn-primary btn-sm d-none" onclick="sendToTwitterList('{{ deputado.api_id }}')">
                                <i class="fab fa-x-twitter"></i> Enviar
                            </button>
                        </div>
                    {% else %}
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fab fa-x-twitter"></i> 
                                {% if not deputado.twitter_url %}
                                    Twitter não encontrado
                                {% else %}
                                    Último tweet não disponível
                                {% endif %}
                            </small>
                        </div>
                    {% endif %}
                    
                    <div class="mt-3">
                        <a href="{% url 'deputado_detail' deputado.api_id %}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye"></i> Ver Detalhes
                        </a>
                    </div>
                </div>
            </div>
        </div>
    {% empty %}
        <div class="col-12">
            <div class="alert alert-info text-center">
                <h4><i class="fas fa-search"></i> Nenhum deputado encontrado</h4>
                <p>Tente ajustar os filtros de busca ou <a href="{% url 'deputados_list' %}">ver todos os deputados</a>.</p>
            </div>
        </div>
    {% endfor %}
</div>

<!-- Pagination -->
{% if page_obj.has_other_pages %}
    <div class="row mt-4">
        <div class="col-12">
            <nav aria-label="Navegação da página">
                <ul class="pagination justify-content-center">
                    <!-- First page -->
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if partido_filter %}partido={{ partido_filter }}&{% endif %}{% if uf_filter %}uf={{ uf_filter }}&{% endif %}{% if has_social_media %}has_social_media={{ has_social_media }}&{% endif %}page=1">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if partido_filter %}partido={{ partido_filter }}&{% endif %}{% if uf_filter %}uf={{ uf_filter }}&{% endif %}{% if has_social_media %}has_social_media={{ has_social_media }}&{% endif %}page={{ page_obj.previous_page_number }}">
                                <i class="fas fa-angle-left"></i>
                            </a>
                        </li>
                    {% endif %}
                    
                    <!-- Current page info -->
                    <li class="page-item active">
                        <span class="page-link">
                            {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                        </span>
                    </li>
                    
                    <!-- Next page -->
                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if partido_filter %}partido={{ partido_filter }}&{% endif %}{% if uf_filter %}uf={{ uf_filter }}&{% endif %}{% if has_social_media %}has_social_media={{ has_social_media }}&{% endif %}page={{ page_obj.next_page_number }}">
                                <i class="fas fa-angle-right"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if partido_filter %}partido={{ partido_filter }}&{% endif %}{% if uf_filter %}uf={{ uf_filter }}&{% endif %}{% if has_social_media %}has_social_media={{ has_social_media }}&{% endif %}page={{ page_obj.paginator.num_pages }}">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
{% endif %}

<script>
// Store generated Twitter links globally for list pages
window.twitterLinksListPage = {};

function handleMessageSelectionList(selectElement, parliamentarianId, type, latestTweetUrl, twitterHandle) {
    const messageId = selectElement.value;
    const sendButton = document.getElementById(`sendButtonList${parliamentarianId}`);
    
    if (!messageId) {
        sendButton.classList.add('d-none');
        return;
    }
    
    // Get message data from selected option
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    const message = selectedOption.dataset.message;
    const hashtags = selectedOption.dataset.hashtags;
    const mentions = selectedOption.dataset.mentions;
    
    // Build formatted message
    let formattedMessage = `${twitterHandle} ${message}`;
    if (mentions) formattedMessage += ` ${mentions}`;
    if (hashtags) formattedMessage += ` ${hashtags}`;
    
    // Show send button
    sendButton.classList.remove('d-none');
    
    // Generate Twitter link and store it
    generateTwitterLinkList(messageId, parliamentarianId, type, formattedMessage, latestTweetUrl);
}

function generateTwitterLinkList(messageId, parliamentarianId, type, formattedMessage, latestTweetUrl) {
    // Extract tweet ID from latest tweet URL
    const tweetIdMatch = latestTweetUrl.match(/\/status\/(\d+)/);
    if (!tweetIdMatch) {
        console.error('Could not extract tweet ID from URL:', latestTweetUrl);
        return;
    }
    
    const tweetId = tweetIdMatch[1];
    const encodedMessage = encodeURIComponent(formattedMessage);
    
    // Generate Twitter intent URL for reply
    const twitterLink = `https://twitter.com/intent/tweet?in_reply_to=${tweetId}&text=${encodedMessage}`;
    
    // Store the link globally
    window.twitterLinksListPage[parliamentarianId] = twitterLink;
}

function sendToTwitterList(parliamentarianId) {
    const twitterLink = window.twitterLinksListPage[parliamentarianId];
    if (twitterLink) {
        // Open Twitter in new window
        window.open(twitterLink, '_blank', 'width=600,height=400,scrollbars=yes,resizable=yes');
        
        // Mark message as used (optional)
        const selectElement = document.getElementById(`messageSelect${parliamentarianId}`);
        const messageId = selectElement.value;
        if (messageId) {
            markMessageAsUsedList(messageId);
        }
        
        // Reset the dropdown
        selectElement.value = '';
        document.getElementById(`sendButtonList${parliamentarianId}`).classList.add('d-none');
    }
}

function markMessageAsUsedList(messageId) {
    // Optional: Make AJAX call to mark message as used
    fetch(`/twitter-link/${messageId}/mark-used/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
            'Content-Type': 'application/json'
        }
    }).catch(error => {
        console.log('Could not mark message as used:', error);
    });
}
</script>

{% endblock %}